<!DOCTYPE HTML>
<html lang="zh_CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>plugin - Substrate 合约书</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> 介绍</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contracts/overview.html"><strong aria-hidden="true">1.1.</strong> 合约综述</a></li><li class="chapter-item expanded "><a href="../contracts/model.html"><strong aria-hidden="true">1.2.</strong> 合约模型</a></li><li class="chapter-item expanded "><a href="../contracts/language.html"><strong aria-hidden="true">1.3.</strong> 合约语言（框架）</a></li><li class="chapter-item expanded "><a href="../contracts/wasm_first_step.html"><strong aria-hidden="true">1.4.</strong> Wasm初步</a></li></ol></li><li class="chapter-item expanded "><a href="../pallet-contracts/introduction.html"><strong aria-hidden="true">2.</strong> pallet-contracts 合约模块</a></li><li class="chapter-item expanded "><a href="../ink/introduction.html"><strong aria-hidden="true">3.</strong> ink!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ink/tutorial.html"><strong aria-hidden="true">3.1.</strong> ink! tutorial</a></li><li class="chapter-item expanded "><a href="../ink/framework.html"><strong aria-hidden="true">3.2.</strong> ink! 框架</a></li><li class="chapter-item expanded "><a href="../ink/edsl-basic.html"><strong aria-hidden="true">3.3.</strong> ink! eDSL基础元素</a></li><li class="chapter-item expanded "><a href="../ink/call-contracts.html"><strong aria-hidden="true">3.4.</strong> ink! 跨合约调用</a></li><li class="chapter-item expanded "><a href="../ink/ink-solidity.html"><strong aria-hidden="true">3.5.</strong> ink! 与solidity的对比</a></li><li class="chapter-item expanded "><a href="../ink/cargo-contract.html"><strong aria-hidden="true">3.6.</strong> cargo-contract</a></li><li class="chapter-item expanded "><a href="../ink/trap.html"><strong aria-hidden="true">3.7.</strong> ink! 当前的坑</a></li></ol></li><li class="chapter-item expanded "><a href="../ask/introduction.html"><strong aria-hidden="true">4.</strong> Ask!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ask/tutorial.html"><strong aria-hidden="true">4.1.</strong> tutorial</a></li><li class="chapter-item expanded "><a href="../ask/design.html"><strong aria-hidden="true">4.2.</strong> 设计</a></li><li class="chapter-item expanded "><a href="../ask/basics.html"><strong aria-hidden="true">4.3.</strong> 基础</a></li><li class="chapter-item expanded "><a href="../ask/example.html"><strong aria-hidden="true">4.4.</strong> example</a></li></ol></li><li class="chapter-item expanded "><a href="../solang/introduction.html"><strong aria-hidden="true">5.</strong> Solang</a></li><li class="chapter-item expanded "><a href="../redspot/introduction.html"><strong aria-hidden="true">6.</strong> Redspot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../redspot/tutorial.html"><strong aria-hidden="true">6.1.</strong> tutorial</a></li><li class="chapter-item expanded "><a href="../redspot/overview.html"><strong aria-hidden="true">6.2.</strong> 介绍</a></li><li class="chapter-item expanded "><a href="../redspot/configuration.html"><strong aria-hidden="true">6.3.</strong> 配置</a></li><li class="chapter-item expanded "><a href="../redspot/runtime-environment.html"><strong aria-hidden="true">6.4.</strong> Runtime Environment</a></li><li class="chapter-item expanded "><a href="../redspot/console.html"><strong aria-hidden="true">6.5.</strong> 控制台console</a></li><li class="chapter-item expanded "><a href="../redspot/q-and-a.html"><strong aria-hidden="true">6.6.</strong> Q &amp; A</a></li><li class="chapter-item expanded "><a href="../redspot/plugin.html" class="active"><strong aria-hidden="true">6.7.</strong> plugin</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../redspot/plugin/redspot-chai.html"><strong aria-hidden="true">6.7.1.</strong> @redspot/chai</a></li><li class="chapter-item expanded "><a href="../redspot/plugin/redspot-gas-reporter.html"><strong aria-hidden="true">6.7.2.</strong> @redspot/gas-reporter</a></li><li class="chapter-item expanded "><a href="../redspot/plugin/redspot-patract.html"><strong aria-hidden="true">6.7.3.</strong> @redspot/patract</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../europa/introduction.html"><strong aria-hidden="true">7.</strong> Europa</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../europa/tutorial.html"><strong aria-hidden="true">7.1.</strong> tutorial</a></li><li class="chapter-item expanded "><a href="../europa/execution_info.html"><strong aria-hidden="true">7.2.</strong> 合约执行日志信息解释</a></li><li class="chapter-item expanded "><a href="../europa/sample.html"><strong aria-hidden="true">7.3.</strong> 根据信息定位问题示例</a></li><li class="chapter-item expanded "><a href="../europa/wasm_executor.html"><strong aria-hidden="true">7.4.</strong> Wasm executor</a></li><li class="chapter-item expanded "><a href="../europa/wasm_backtrace.html"><strong aria-hidden="true">7.5.</strong> Wasm Backtrace</a></li></ol></li><li class="chapter-item expanded "><a href="../zkmega/introduction.html"><strong aria-hidden="true">8.</strong> zkMega</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkmega/tutorial.html"><strong aria-hidden="true">8.1.</strong> tutorial</a></li><li class="chapter-item expanded "><a href="../zkmega/contract.html"><strong aria-hidden="true">8.2.</strong> 零知识合约</a></li><li class="chapter-item expanded "><a href="../zkmega/example.html"><strong aria-hidden="true">8.3.</strong> 使用案例</a></li><li class="chapter-item expanded "><a href="../zkmega/benchmark.html"><strong aria-hidden="true">8.4.</strong> benchmark</a></li></ol></li><li class="chapter-item expanded "><a href="../himalia/introduction.html"><strong aria-hidden="true">9.</strong> Himalia</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../himalia/tutorial.html"><strong aria-hidden="true">9.1.</strong> tutorial</a></li><li class="chapter-item expanded "><a href="../himalia/go-patract.html"><strong aria-hidden="true">9.2.</strong> go-patract</a></li><li class="chapter-item expanded "><a href="../himalia/py-patract.html"><strong aria-hidden="true">9.3.</strong> py-patract</a></li></ol></li><li class="chapter-item expanded "><a href="../metis/introduction.html"><strong aria-hidden="true">10.</strong> Metis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../metis/tokens.html"><strong aria-hidden="true">10.1.</strong> Tokens</a></li><li class="chapter-item expanded "><a href="../metis/access-control.html"><strong aria-hidden="true">10.2.</strong> Access Control</a></li></ol></li><li class="chapter-item expanded "><a href="../carpo/introduction.html"><strong aria-hidden="true">11.</strong> Carpo</a></li><li class="chapter-item expanded "><a href="../patract/introduction.html"><strong aria-hidden="true">12.</strong> Patract</a></li><li class="chapter-item expanded "><a href="../elara/introduction.html"><strong aria-hidden="true">13.</strong> Elara</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../elara/tutorial.html"><strong aria-hidden="true">13.1.</strong> tutorial</a></li><li class="chapter-item expanded "><a href="../elara/design.html"><strong aria-hidden="true">13.2.</strong> 设计</a></li><li class="chapter-item expanded "><a href="../elara/API.html"><strong aria-hidden="true">13.3.</strong> API</a></li></ol></li><li class="chapter-item expanded "><a href="../patra-store/introduction.html"><strong aria-hidden="true">14.</strong> PatraStore</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../patra-store/overview.html"><strong aria-hidden="true">14.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../patra-store/getting-starter.html"><strong aria-hidden="true">14.2.</strong> Getting Starter</a></li><li class="chapter-item expanded "><a href="../patra-store/publish-dapps.html"><strong aria-hidden="true">14.3.</strong> 发布DApp</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                        
                        <button id="language-toggle" class="icon-button" type="button" title="Select language" aria-label="Select language" aria-haspopup="true" aria-expanded="false" aria-controls="language-list">
                            <i class="fa fa-globe"></i>
                        </button>
                        <ul id="language-list" class="language-popup" aria-label="Languages" role="menu">
                          
                            <li role="none"><a href="../../en_US/redspot/plugin.html"><button role="menuitem" class="language" id="light">English</button></a></li>
                          
                            <li role="none"><a href="../../zh_CN/redspot/plugin.html"><button role="menuitem" class="language" id="light">中文</button></a></li>
                          
                        </ul>
                        
                    </div>

                    <h1 class="menu-title">Substrate 合约书</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#插件" id="插件">插件</a></h1>
<p>Redspot 的核心功能包括 Redspot runtime environment 和编译合约，运行测试，运行脚本这几个任务。</p>
<p>其他诸如与合约的测试套件，合约交互，访问合约，设置不同的链的配置，等功能均有插件提供。用户可以自行选择需要使用的插件。引入一个插件很简单。将它作为一个 npm 的依赖添加。然后在 <code>redspot.config.ts</code> 中加入：</p>
<pre><code class="language-typescript">import { RedspotUserConfig } from 'redspot/types';
import '@redspot/patract'; // 引入 @redspot/patract 插件
import '@redspot/chai'; // 引入 @redspot/chai 插件

export default {
 ...
} as RedspotUserConfig;
</code></pre>
<p>下面我们介绍一下官方提供的几个插件：</p>
<h2><a class="header" href="#redspotpatract" id="redspotpatract">@redspot/patract</a></h2>
<p>该插件会扩展 Redspot runtime environment ，并添加 patract 属性，可以这样访问 patract 实例：</p>
<pre><code class="language-typescript">import { patract } from 'redspot' 
</code></pre>
<p>patract 的类型定义如下：</p>
<pre><code class="language-typescript">interface Patract {
     Contract: Contract;
     ContractFactory: ContractFactory;
    /**
     * Generating Contract Instance from Contract Addresses
     *
     * @param contractName Contract name
     * @param address contract address
     * @param signer The account used to sign, or the first account in the user configured if it is undefined.
     * @returns Contract Instance
     */
    getContractAt(
      contractName: string,
      address: AccountId | string,
      signer?: Signer
    ): Promise&lt;Contract&gt;;
    /**
     * Return the contract factory
     *
     * @param contractName Contract name
     * @param signer The account used to sign, or the first account in the user configured if it is undefined.
     * @returns Contract Factory Instance
     */
    getContractFactory(
      contractName: string,
      signer?: Signer
    ): Promise&lt;ContractFactory&gt;;
    /**
     *  Generate a random account and transfer token to it
     *
     * @param from This account will be transferred to the new account
     * @param amount The amount transferred to the new account
     * @returns New Account
     */
    getRandomSigner(
      from?: Signer,
      amount?: BN | number | string | BigInt
    ): Promise&lt;Signer&gt;;
  
  };
</code></pre>
<h4><a class="header" href="#getrandomsignerfrom-amount-promisesigner" id="getrandomsignerfrom-amount-promisesigner"><code>getRandomSigner(from, amount): Promise&lt;Signer&gt;</code></a></h4>
<p>getRandomSigner 是一个工具函数，用于创建生成随机的signer，并且从 from 传递一些初始的金额给它。</p>
<h4><a class="header" href="#getcontractfactorycontractname-signer--promisecontractfactory" id="getcontractfactorycontractname-signer--promisecontractfactory"><code>getContractFactory(contractName, signer?):  Promise&lt;ContractFactory&gt;</code></a></h4>
<p>该函数将通过合约名字和 signer ，创建一个 contractFactory 的实例。</p>
<p>注意合约必须已编译成功。能够在 artifacts 找到对于的 metadata 文件。</p>
<h4><a class="header" href="#getcontractatcontractname-address-signer-promisecontract" id="getcontractatcontractname-address-signer-promisecontract"><code>getContractAt(contractName, address, signer): Promise&lt;Contract&gt;</code></a></h4>
<p>通过合约名字，合约地址和 signer，创建一个 Contract 实例。</p>
<p>注意合约必须已编译成功。能够在 artifacts 找到对于的 metadata 文件。</p>
<p>###ContractFactory</p>
<p>ContractFactory 主要用于合约的部署：</p>
<pre><code class="language-typescript">import { patract } from 'redspot'
const { getContractFactory, getRandomSigner } = patract;

const signers = await getSigners();
const contractFactory = await getContractFactory('erc20', signers[0]);
const contract = await contractFactory.deploy('new', '1000');
</code></pre>
<h4><a class="header" href="#new-contractfactoryaddress-contractmetadata-api-signer" id="new-contractfactoryaddress-contractmetadata-api-signer"><code>new ContractFactory(address, contractMetadata, api, signer) </code></a></h4>
<p>通过合约地址，metadata，api  和  signer 创建一个 contractFactory  实例。</p>
<h4><a class="header" href="#contractfactorydeployconstructororid-args--overrides---promisecontract" id="contractfactorydeployconstructororid-args--overrides---promisecontract"><code>contractFactory.deploy(constructorOrId, ...args[ , overrides ]):  Promise&lt;Contract&gt;</code></a></h4>
<p>constructorOrId 是需要调用的合约的 contructor 的名字，注意对于一些使用了 <code>trait</code> 的合约，contructor  的名字应该是类似这样：</p>
<pre><code class="language-typescript">const contract = await contractFactory.deploy('baseErc20,new', '1000');
</code></pre>
<p>args 是你所使用的 contructor 需要传入参数列表。</p>
<p>overrides 是可选项，可以用于指定 gasLimit, value, signer, salt 等。</p>
<pre><code class="language-typescript">const contract = await contractFactory.deploy('baseErc20,new', '1000', {
  gaslimit: '1000000000000000000',
  salt: 'jkqwezlkwklqreqw',
  signer: signers[1],
  value: '3213321000000000000000000'
});
</code></pre>
<p>gasLimit 指这次交易能够使用的最大的 gas 值。</p>
<p>salt 用于合约的地址的生成。部署人，部署参数和 salt 一致的话，将会生成同一个合约地址。</p>
<p>signer 创建 contractFactory 时，会有一个 signer 参数，用于默认的交易签名。 signer 项目可以覆盖默认的签名账户。</p>
<p>value 指传递给即将创建的合约的金额。</p>
<p>请注意，<code>@redspot/patract</code> 不会处理数字金额精度，需要用户自行处理。</p>
<h4><a class="header" href="#contractfactorydeployedconstructororid-args--overrides---promisecontract" id="contractfactorydeployedconstructororid-args--overrides---promisecontract"><code>contractFactory.deployed(constructorOrId, ...args[ , overrides ]):  Promise&lt;Contract&gt;</code></a></h4>
<p>该方法和 <code>contractFactory.deploy</code> 类似，唯一的区别是，<code>deployed</code> 会预先检查即将生成的合约地址是否存在，如果存在不会去尝试部署，而是直接使用该合约地址创建 <code>Contract</code> 实例。</p>
<h4><a class="header" href="#contractfactoryinstantiateconstructororid-args--overrides---promisecontractaddress" id="contractfactoryinstantiateconstructororid-args--overrides---promisecontractaddress"><code>contractFactory.instantiate(constructorOrId, ...args[ , overrides ]):  Promise&lt;ContractAddress&gt;</code></a></h4>
<p>如果 wasm 已上传到链上，你可以直接调用 <code>contractFactory.instantiate</code> 实例化合约。它的参数与 <code>deploy</code> 一致，但返回的是合约地址。</p>
<h4><a class="header" href="#contractfactoryinstantiateconstructororid-args--overrides---promisecontractaddress-1" id="contractfactoryinstantiateconstructororid-args--overrides---promisecontractaddress-1"><code>contractFactory.instantiate(constructorOrId, ...args[ , overrides ]):  Promise&lt;ContractAddress&gt;</code></a></h4>
<p>如果 wasm 已上传到链上，你可以直接调用 <code>contractFactory.instantiate</code> 实例化合约。它的参数与 <code>deploy</code> 一致，但返回的是合约地址。</p>
<h4><a class="header" href="#contractfactoryattachaddresscontract" id="contractfactoryattachaddresscontract"><code>contractFactory.attach(address)：Contract</code></a></h4>
<p>使用指定的合约地址生成 <code>Contract</code> 实例</p>
<p>####<code>contractFactory.connect(signer)：contractFactory</code></p>
<p>使用指定的 signer，创建一个新的 contractFactory 实例</p>
<h3><a class="header" href="#contract" id="contract">Contract</a></h3>
<h4><a class="header" href="#new-contractaddress-contractmetadata-api-signer" id="new-contractaddress-contractmetadata-api-signer"><code>new Contract(address, contractMetadata, api, signer) </code></a></h4>
<p>通过合约地址，合约的metadata，api  和  signer 创建一个 contractFactory  实例。</p>
<h4><a class="header" href="#contractquerymessagenameargs-overrides" id="contractquerymessagenameargs-overrides"><code>contract.query.MessageName(...args[, overrides])</code></a></h4>
<p>与 polkadotjs 中类似， contract.query[MessageName] 能够调用 <code>contracts.call</code> rpc。如在 erc20 合约中，获取账户余额：</p>
<pre><code class="language-typescript">const result = await contract.query.balanceOf(someaddress)
</code></pre>
<p>返回值的类型如下：</p>
<pre><code class="language-typescript">export interface ContractCallOutcome {
    debugMessage: Text;
    gasConsumed: u64;
    output: Codec | null;
    result: ContractExecResultResult;
}
</code></pre>
<p>它和 polkadotjs api-contract 中是一致。</p>
<p>overrides 是可选项，可以用于指定 gasLimit, value 等。</p>
<pre><code class="language-typescript">const contract = await contract.query.balanceOf('baseErc20,new', '1000', {
	gasLimit：'1231231231233123123'
  value: '3213321000000000000000000'
  signer： signers[1]
});
</code></pre>
<p>gasLimit value 指的是 <code>contracts.call</code> rpc 中的 gasLimit 和 value 。signer 可以指定 <code>contracts.call</code> 的 origin 地址。</p>
<h4><a class="header" href="#contractestimategasmessagenameargs-overrides" id="contractestimategasmessagenameargs-overrides"><code>contract.estimateGas.MessageName(...args[, overrides])</code></a></h4>
<p>该函数与 <code>contract.query.MessageName</code> 类似，但返回值是预估将要消耗的 gas</p>
<pre><code class="language-typescript">const result = await contract.estimateGas.balanceOf(someaddress)
result // BN(232130000000)
</code></pre>
<h4><a class="header" href="#contracttxmessagenameargsoverrides" id="contracttxmessagenameargsoverrides"><code>contract.tx.MessageName(...args[,overrides])</code></a></h4>
<p>通过  <code>contract.tx.MessageName</code> 可以执行合约的交易。 如：</p>
<pre><code class="language-typescript">const result = await contract.tx.transfer(someddress, 7)
</code></pre>
<p>和 polkadotjs 不同，该函数会返回一个 promise ， 会等到 交易上链，或者出错才被 resolved。</p>
<p>返回值类型如下：</p>
<pre><code class="language-typescript">export interface TransactionResponse {
  from: string;
  txHash?: string;
  blockHash?: string;
  error?: {
    message?: any;
    data?: any;
  };
  result: SubmittableResult;
  events?: DecodedEvent[];
}

export interface DecodedEvent {
  args: Codec[];
  name: string;
  event: AbiEvent;
}
</code></pre>
<p>你可以直接通过 <code>result.events</code> 获取已解析的合约的事件。如果执行出错，你可以通过 <code>result.error.message</code> 获取错误信息。</p>
<p>overrides 是可选项，可以用于指定 gasLimit，value，signer  等。</p>
<pre><code class="language-typescript">const contract = await contract.tx.transfer(someddress, 7, {
  gasLimit：'1231231231233123123'
  value: '3213321000000000000000000'
  signer： signers[1]
});
</code></pre>
<p>ggasLimit 指这次交易能够使用的最大的 gas 值。</p>
<p>value 指传递给即将创建的合约的金额。</p>
<p>signer 用于覆盖默认的 signer。</p>
<h4><a class="header" href="#contractattachaddresscontract" id="contractattachaddresscontract"><code>contract.attach(address)：Contract</code></a></h4>
<p>使用指定的合约地址生成 <code>Contract</code> 实例</p>
<p>####<code>contract.connect(signer)：contractFactory</code></p>
<p>使用指定的 signer，创建一个新的 contract 实例</p>
<h2><a class="header" href="#redspotchai" id="redspotchai">@redspot/chai</a></h2>
<p>该插件提供了一组便于编写合约测试用例的匹配器，灵感来自于 <a href="https://ethereum-waffle.readthedocs.io/en/latest/matchers.html">waffle</a> 。</p>
<p>引入 @redspot/chai。该插件会自动修改 chai 匹配器，无需手动调用。</p>
<pre><code>// redspot.config.ts

import { RedspotUserConfig } from 'redspot/types';
import '@redspot/chai'; 

export default {
 ...
} as RedspotUserConfig;
</code></pre>
<p>使用 @redspot/chai 的完整例子：</p>
<pre><code class="language-typescript">import BN from 'bn.js';
import { expect } from 'chai';
import { patract, network, artifacts } from 'redspot';

const { getContractFactory, getRandomSigner } = patract;

const { api, getSigners } = network;

describe('ERC20', () =&gt; {
  after(() =&gt; {
    return api.disconnect();
  });

  async function setup() {
    const one = new BN(10).pow(new BN(api.registry.chainDecimals[0]));
    const signers = await getSigners();
    const Alice = signers[0];
    const sender = Alice;
    const contractFactory = await getContractFactory('erc20', sender);
    const contract = await contractFactory.deploy('new', '1000');
    const abi = artifacts.readArtifact('erc20');
    const receiver = await getRandomSigner();

    return { sender, contractFactory, contract, abi, receiver, Alice, one };
  }

  it('Assigns initial balance', async () =&gt; {
    const { contract, sender } = await setup();
    const result = await contract.query.balanceOf(sender.address);
    expect(result.output).to.equal(1000);
  });

  it('Transfer adds amount to destination account', async () =&gt; {
    const { contract, receiver } = await setup();
    await expect(() =&gt;
      contract.tx.transfer(receiver.address, 7)
    ).to.changeTokenBalance(contract, receiver, 7);

    await expect(() =&gt;
      contract.tx.transfer(receiver.address, 7)
    ).to.changeTokenBalances(contract, [contract.signer, receiver], [-7, 7]);
  });

  it('Transfer emits event', async () =&gt; {
    const { contract, sender, receiver } = await setup();

    await expect(contract.tx.transfer(receiver.address, 7))
      .to.emit(contract, 'Transfer')
      .withArgs(sender.address, receiver.address, 7);
  });

  it('Can not transfer above the amount', async () =&gt; {
    const { contract, receiver } = await setup();

    await expect(contract.tx.transfer(receiver.address, 1007)).to.not.emit(
      contract,
      'Transfer'
    );
  });

  it('Can not transfer from empty account', async () =&gt; {
    const { contract, Alice, one, sender } = await setup();

    const emptyAccount = await getRandomSigner(Alice, one.muln(10000));

    await expect(
      contract.tx.transfer(sender.address, 7, {
        signer: emptyAccount
      })
    ).to.not.emit(contract, 'Transfer');
  });
});

</code></pre>
<p>chai 还有更多的内置的用法，参见 chai 文档： https://www.chaijs.com/。</p>
<h3><a class="header" href="#equal" id="equal">equal</a></h3>
<p>@redspot/chai 会修改默认的 equal 的匹配方式。默认的 equal 不支持匹配对象。但 @redspot/chai 可以：</p>
<pre><code class="language-typescript">expect(new BN(1000)).to.equal(1000) // true
expect(AccountId).to.equal('5Gdjkw....') // true
expect(Uint8Array([1,2,3])).to.equal('0x010203') // true
</code></pre>
<p>对于 BN 类型，equal 对调用 <code>new BN(expected).eq(actual)</code> 判断是否相等</p>
<p>对于 polkadotjs 中定义的类型，equal 会调用 <code>Type.eq(actual)</code> 判断是否相等</p>
<p>对于 uint8Array 类型，equal 会将他们都转化为 hex ，再比较是否相等</p>
<p>其他类型则采用默认的判断方式，判断是否相等</p>
<h3><a class="header" href="#changetokenbalance" id="changetokenbalance">changeTokenBalance</a></h3>
<p>该匹配器可以检测 erc20 的余额变化，内部会调用 balanceOf 接口判断余额。由于 erc20-trait 的获取余额接口是 <code>baseErc20,balanceOf</code> </p>
<p>所以并不适用于 erc20-trait 。</p>
<pre><code class="language-typescript">await expect(() =&gt;
  contract.tx.transfer(receiver.address, 7)
).to.changeTokenBalance(contract, receiver, 7);

await expect(() =&gt;
  contract.tx.transfer(receiver.address, 7)
).to.changeTokenBalances(contract, [contract.signer, receiver], [-7, 7]);
</code></pre>
<h3><a class="header" href="#emit" id="emit">emit</a></h3>
<p>该匹配器可以检测合约是否发出事件，如检测是否有 Transfer 事件被 emit：</p>
<pre><code class="language-typescript">await expect(contract.tx.transfer(receiver.address, 7))
    .to.emit(contract, 'Transfer')
</code></pre>
<p>检测该事件是否包含指定的参数：</p>
<pre><code class="language-typescript">await expect(contract.tx.transfer(receiver.address, 7))
    .to.emit(contract, 'Transfer')
    .withArgs(sender.address, receiver.address, 7);
</code></pre>
<p>不期待发出事件</p>
<pre><code class="language-typescript">await expect(
  contract.tx.transfer(sender.address, 7, {
    signer: emptyAccount
  })
).to.not.emit(contract, 'Transfer');

</code></pre>
<h2><a class="header" href="#redspotgas-reporter" id="redspotgas-reporter">@redspot/gas-reporter</a></h2>
<p>该插件会在测试完成时，打印出所调用的合约的交易的 gas 使用量：</p>
<p><img src="https://user-images.githubusercontent.com/7029338/101343840-7700ab00-38e9-11eb-80a0-c6b6d38a9640.png" alt="" /></p>
<p>和 @redspot/chai 一样，只需要在引入 @redspot/gas-reporter 后，在 redspot.config.ts 中加入：</p>
<pre><code>// redspot.config.ts

import { RedspotUserConfig } from 'redspot/types';
import '@redspot/gas-reporter'; 

export default {
 ...
} as RedspotUserConfig;
</code></pre>
<p>即可自动运行。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../redspot/q-and-a.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../redspot/plugin/redspot-chai.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../redspot/q-and-a.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../redspot/plugin/redspot-chai.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
